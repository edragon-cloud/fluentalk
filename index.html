<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fluentalk | AI Speaking Coach</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ Microsoft-inspired color palette ‚îÄ‚îÄ */
:root {
  --bg:#f3f6fb; --bg2:#e8eef8; --bg3:#d5e3f5; --card:#ffffff; --card2:#f7f9fd;
  --border:#c5d8ef;
  --blue:#0078d4; --blue2:#106ebe; --blue3:#005a9e; --blue-lt:#deedf7; --blue-xlt:#eef5fb;
  --teal:#008272; --teal2:#00a693; --teal-lt:#e0f5f3;
  --purple:#5c2d91; --purple2:#7719aa; --purple-lt:#ede0ff;
  --green:#107c10; --green2:#128a12; --green3:#43b143; --green-lt:#e3f4e3;
  --orange:#d83b01; --orange2:#bc3201; --orange-lt:#fbeee8;
  --red:#d13438; --yellow:#ffb900; --yellow2:#c47e00;
  --text:#1b1b1b; --text2:#444; --text3:#767676;
  --font:'Plus Jakarta Sans','Segoe UI',system-ui,sans-serif;
  --font-brand:'Nunito',sans-serif;
  --radius:12px; --fs:15px;
  --shadow:0 2px 12px rgba(0,60,130,.08);
  --shadow2:0 8px 32px rgba(0,60,130,.14);
  --glow-b:0 0 0 3px rgba(0,120,212,.22);
  --glow-t:0 0 0 3px rgba(0,130,114,.2);
  --glow-p:0 0 0 3px rgba(92,45,145,.2);
  --glow-g:0 0 0 3px rgba(16,124,16,.2);
  --glow-o:0 0 0 3px rgba(216,59,1,.2);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:var(--fs);line-height:1.6;-webkit-font-smoothing:antialiased;}

/* ‚îÄ‚îÄ Keyframes ‚îÄ‚îÄ */
@keyframes fadeIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
@keyframes slideIn{from{opacity:0;transform:translateX(-16px);}to{opacity:1;transform:translateX(0);}}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes waveform{0%,100%{height:4px;}50%{height:24px;}}
@keyframes blinkRed{0%,49%{color:#d13438;}50%,100%{color:transparent;}}
@keyframes blinkGreen{0%,49%{color:#107c10;}50%,100%{color:transparent;}}
@keyframes gradShift{0%,100%{background-position:0% 50%;}50%{background-position:100% 50%;}}
@keyframes shimmer{0%{left:-60%;}100%{left:120%;}}
@keyframes ripple{0%{box-shadow:0 0 0 0 rgba(0,120,212,.45);}70%{box-shadow:0 0 0 22px rgba(0,120,212,0);}100%{box-shadow:0 0 0 0 rgba(0,120,212,0);}}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
@keyframes dotBounce{0%,80%,100%{transform:scale(0);}40%{transform:scale(1);}}
.think-dot{
  width:7px;height:7px;border-radius:50%;
  background:var(--blue);
  animation:dotBounce 1.2s ease-in-out infinite;
}
.think-dot:nth-child(2){animation-delay:.2s;background:var(--teal);}
.think-dot:nth-child(3){animation-delay:.4s;background:var(--purple);}
@keyframes borderPulse{0%,100%{box-shadow:0 0 0 2px rgba(0,120,212,.35),var(--shadow);}50%{box-shadow:0 0 0 4px rgba(0,120,212,.15),var(--shadow);}}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.app{max-width:880px;margin:0 auto;padding:20px 16px 60px;}
.page{display:none;animation:fadeIn .4s ease;}
.page.active{display:block;}

/* ‚îÄ‚îÄ Zoom bar ‚îÄ‚îÄ */
.zoom-bar{position:fixed;top:14px;right:16px;z-index:300;display:flex;align-items:center;gap:6px;background:#fff;border:1.5px solid var(--border);border-radius:30px;padding:5px 12px;box-shadow:var(--shadow2);}
.zoom-btn{width:28px;height:28px;border-radius:50%;border:1.5px solid var(--border);background:var(--bg2);color:var(--text);font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.zoom-btn:hover{background:var(--blue);color:#fff;border-color:var(--blue);}
.zoom-val{font-size:12px;font-weight:700;color:var(--text2);min-width:34px;text-align:center;}

/* ‚îÄ‚îÄ App header ‚Äî Microsoft gradient ‚îÄ‚îÄ */
.app-header{
  background:linear-gradient(135deg,#0078d4 0%,#106ebe 28%,#008272 62%,#5c2d91 100%);
  background-size:300% 300%;
  animation:gradShift 8s ease infinite;
  border-radius:var(--radius);padding:30px 28px 22px;margin-bottom:22px;
  color:#fff;
  box-shadow:0 8px 32px rgba(0,70,180,.25),inset 0 0 0 1px rgba(255,255,255,.12);
  position:relative;overflow:hidden;
}
.app-header::before{content:'';position:absolute;top:-50%;left:-30%;width:160%;height:200%;background:radial-gradient(ellipse at 35% 40%,rgba(255,255,255,.10) 0%,transparent 60%);pointer-events:none;}

/* ‚îÄ‚îÄ Brand title ‚Äî Nunito 900 upright ‚îÄ‚îÄ */
.app-header h1{
  font-family:var(--font-brand);
  font-weight:900;
  font-style:normal;
  font-size:clamp(26px,5vw,46px);
  letter-spacing:-0.5px;
  margin-bottom:4px;
  text-shadow:0 2px 10px rgba(0,0,0,.2);
  display:flex;align-items:center;gap:14px;
}
/* Speaking person icon bubble */
.brand-icon{
  display:inline-flex;align-items:center;justify-content:center;
  width:46px;height:46px;
  background:rgba(255,255,255,.22);
  border-radius:50%;
  flex-shrink:0;
  box-shadow:inset 0 0 0 1.5px rgba(255,255,255,.4);
}
.brand-icon svg{width:26px;height:26px;}
.app-header p{opacity:.9;font-size:calc(var(--fs) - 1px);font-weight:500;}

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:18px;box-shadow:var(--shadow);transition:box-shadow .3s,border-color .25s;}
.card:hover{box-shadow:0 6px 24px rgba(0,70,160,.11),0 0 0 2px rgba(0,120,212,.10);}
.card.glow-anim{animation:borderPulse 4s ease-in-out infinite;}
.card-title{font-size:calc(var(--fs)+1px);font-weight:700;color:var(--blue);margin-bottom:18px;display:flex;align-items:center;gap:8px;border-bottom:2px solid var(--bg3);padding-bottom:12px;}

/* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
.form-label{display:block;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:7px;}
.form-input,.form-textarea{width:100%;padding:12px 16px;background:var(--bg2);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-size:var(--fs);transition:all .2s;outline:none;}
.form-input:focus,.form-textarea:focus{border-color:var(--blue);background:#fff;box-shadow:var(--glow-b);}
.form-textarea{min-height:90px;resize:vertical;line-height:1.7;}

/* ‚îÄ‚îÄ Mode buttons ‚îÄ‚îÄ */
.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
.mode-btn{padding:18px 12px;border-radius:12px;border:2px solid var(--border);background:var(--bg2);color:var(--text);font-family:var(--font);font-size:calc(var(--fs)-2px);font-weight:600;cursor:pointer;transition:all .25s;text-align:center;}
.mode-btn:hover{border-color:var(--blue);background:var(--blue-xlt);box-shadow:var(--glow-b);}
.mode-btn.selected{border-color:var(--blue);background:linear-gradient(135deg,var(--blue-xlt),var(--blue-lt));color:var(--blue);box-shadow:var(--glow-b);animation:float 3s ease-in-out infinite;}
.mode-icon{font-size:26px;display:block;margin-bottom:6px;}
.mode-label{font-size:calc(var(--fs)-1px);font-weight:700;}
.mode-sub{font-size:calc(var(--fs)-4px);color:var(--text3);margin-top:3px;}

/* ‚îÄ‚îÄ IELTS parts ‚îÄ‚îÄ */
.ielts-parts{display:none;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;padding:14px;background:var(--bg3);border-radius:10px;border:1.5px dashed #88b8e8;}
.ielts-parts.show{display:grid;}
.part-btn{padding:12px 10px;border-radius:10px;border:2px solid var(--border);background:#fff;color:var(--text2);font-family:var(--font);font-size:calc(var(--fs)-2px);font-weight:600;cursor:pointer;transition:all .25s;line-height:1.5;}
.part-btn:hover{border-color:var(--teal2);color:var(--teal);}
.part-btn.selected{border-color:var(--teal);background:linear-gradient(135deg,var(--teal-lt),#b8e8e4);color:var(--teal);box-shadow:var(--glow-t);}

/* ‚îÄ‚îÄ Sim modes ‚îÄ‚îÄ */
.sim-modes{display:none;flex-direction:column;gap:8px;margin-top:10px;padding:14px;background:#faf0ff;border-radius:10px;border:1.5px dashed #c4a0e0;}
.sim-modes.show{display:flex;}
.sim-opt{padding:12px 16px;border-radius:10px;border:2px solid var(--border);background:#fff;color:var(--text2);font-family:var(--font);font-size:calc(var(--fs)-1px);font-weight:600;cursor:pointer;transition:all .25s;text-align:left;display:flex;align-items:center;gap:10px;}
.sim-opt:hover{border-color:var(--purple2);color:var(--purple);}
.sim-opt.selected{border-color:var(--purple);background:linear-gradient(135deg,var(--purple-lt),#e0d0f8);color:var(--purple);box-shadow:var(--glow-p);}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:12px 24px;border-radius:8px;border:none;cursor:pointer;font-family:var(--font);font-size:var(--fs);font-weight:600;letter-spacing:0.01em;transition:all .2s;}
.btn-primary{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(0,120,212,.32);}
.btn-primary:hover{background:var(--blue2);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,120,212,.4);}
.btn-teal{background:var(--teal);color:#fff;}
.btn-teal:hover{background:var(--teal2);transform:translateY(-1px);}
.btn-orange{background:var(--orange);color:#fff;}
.btn-orange:hover{background:var(--orange2);transform:translateY(-1px);}
.btn-success{background:var(--green);color:#fff;}
.btn-success:hover{background:var(--green2);transform:translateY(-1px);}
.btn-ghost{background:#fff;color:var(--text2);border:1.5px solid var(--border);}
.btn-ghost:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-xlt);}
.btn-full{width:100%;}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important;}
.btn-sm{padding:8px 16px;font-size:calc(var(--fs)-2px);}
.btn-group{display:flex;gap:10px;flex-wrap:wrap;}

/* ‚îÄ‚îÄ Setup ‚îÄ‚îÄ */
.setup-part-section{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;box-shadow:var(--shadow);}
.setup-part-title{font-size:13px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;display:flex;align-items:center;gap:8px;padding-bottom:10px;border-bottom:1.5px solid var(--bg3);}
.q-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;padding:14px;background:var(--bg2);border-radius:10px;border:1.5px solid var(--border);}
@media(max-width:640px){.q-row{grid-template-columns:1fr;}}
.q-input-wrap label{display:block;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;}
.q-input-wrap textarea{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;font-family:var(--font);font-size:var(--fs);background:#fff;color:var(--text);resize:vertical;min-height:70px;outline:none;transition:all .2s;}
.q-input-wrap textarea:focus{border-color:var(--blue);box-shadow:var(--glow-b);}
.a-input-wrap label{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.a-label-text{font-size:11px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.8px;}
.a-input-wrap textarea{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;font-family:var(--font);font-size:var(--fs);background:#fff;color:var(--text);resize:vertical;min-height:80px;outline:none;transition:all .2s;}
.a-input-wrap textarea:focus{border-color:var(--teal);box-shadow:var(--glow-t);}
.sample-btn{padding:4px 10px;font-size:11px;font-weight:700;background:var(--orange);color:#fff;border:none;border-radius:6px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.sample-btn:hover{background:var(--orange2);transform:scale(1.04);}
.add-q-btn{width:100%;padding:9px;border-radius:8px;border:2px dashed #88b8e8;background:transparent;color:var(--text3);font-family:var(--font);font-size:calc(var(--fs)-1px);font-weight:600;cursor:pointer;transition:all .2s;margin-top:6px;}
.add-q-btn:hover{border-color:var(--blue);color:var(--blue);background:var(--blue-xlt);}
.forecast-area{width:100%;min-height:160px;padding:14px;background:var(--bg2);border:1.5px solid var(--border);border-radius:10px;font-family:var(--font);font-size:var(--fs);color:var(--text);resize:vertical;outline:none;line-height:1.7;transition:all .2s;}
.forecast-area:focus{border-color:var(--blue);background:#fff;box-shadow:var(--glow-b);}

/* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
.progress-area{margin-bottom:18px;}
.progress-label{display:flex;justify-content:space-between;font-size:calc(var(--fs)-3px);color:var(--text2);margin-bottom:6px;}
.progress-track{height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--teal),var(--purple));background-size:200% 100%;animation:gradShift 3s ease infinite;transition:width .5s ease;}

/* ‚îÄ‚îÄ Timer ‚îÄ‚îÄ */
.timer-display{text-align:center;padding:18px 20px;background:linear-gradient(135deg,var(--blue),var(--teal),var(--purple));background-size:250% 250%;animation:gradShift 5s ease infinite;border-radius:14px;margin-bottom:18px;color:#fff;box-shadow:0 6px 24px rgba(0,70,180,.3),inset 0 0 0 2px rgba(255,255,255,.12);}
.timer-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;opacity:.8;margin-bottom:6px;}
.timer-value{font-size:58px;font-weight:800;line-height:1;text-shadow:0 2px 8px rgba(0,0,0,.2);}
.timer-value.blink-red{animation:blinkRed 1s steps(1) infinite;}
.timer-value.blink-green{animation:blinkGreen 1s steps(1) infinite;}
.timer-bar{height:6px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:10px;overflow:hidden;}
.timer-bar-fill{height:100%;background:#fff;border-radius:3px;transition:width 1s linear;box-shadow:0 0 8px rgba(255,255,255,.6);}

/* ‚îÄ‚îÄ Question ‚îÄ‚îÄ */
.question-display{background:linear-gradient(135deg,var(--blue-xlt),var(--blue-lt));border:2px solid #88b8e8;border-radius:14px;padding:22px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,70,160,.08);position:relative;overflow:hidden;}
.question-display::after{content:'';position:absolute;top:0;left:-60%;width:40%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);animation:shimmer 3.5s ease-in-out infinite;}
.question-num{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--blue);margin-bottom:8px;font-weight:700;}
.question-text{font-size:calc(var(--fs)+2px);font-weight:500;line-height:1.65;color:var(--text);}

/* ‚îÄ‚îÄ Hint toggle ‚îÄ‚îÄ */
.hint-toggle{display:flex;gap:8px;margin-bottom:14px;background:var(--bg2);border-radius:10px;padding:4px;border:1.5px solid var(--border);}
.hint-opt{flex:1;padding:10px 8px;border-radius:8px;border:none;font-family:var(--font);font-size:calc(var(--fs)-2px);font-weight:600;cursor:pointer;transition:all .25s;color:var(--text2);background:transparent;}
.hint-opt.active{background:#fff;color:var(--blue);box-shadow:0 2px 8px rgba(0,120,212,.14);}

/* ‚îÄ‚îÄ Keywords ‚îÄ‚îÄ */
.keywords-box{background:linear-gradient(135deg,#fffbe6,#fff5cc);border:2px solid #f0cc6a;border-radius:12px;padding:16px;margin-bottom:14px;display:none;animation:fadeIn .3s ease;}
.keywords-box.show{display:block;}
.keywords-label{font-size:11px;font-weight:700;color:var(--yellow2);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.kw-chips{display:flex;flex-wrap:wrap;gap:7px;}
.kw-chip{padding:5px 13px;border-radius:20px;background:var(--blue);color:#fff;font-size:calc(var(--fs)-3px);font-weight:600;box-shadow:0 2px 6px rgba(0,120,212,.28);transition:transform .2s;cursor:default;}
.kw-chip:hover{transform:scale(1.06);}
.kw-chip.teal{background:var(--teal);}
.kw-chip.blue{background:var(--purple);}
.kw-chip.orange{background:var(--orange);}
.kw-chip.green{background:var(--green);}
.kw-arrow{
  display:inline-flex;align-items:center;
  color:var(--text3);font-size:16px;font-weight:700;
  margin:0 3px;line-height:1;
  vertical-align:middle;
  user-select:none;
}

/* ‚îÄ‚îÄ Mic ‚îÄ‚îÄ */
.mic-area{display:flex;flex-direction:column;align-items:center;gap:14px;padding:20px;}
.waveform{display:flex;align-items:center;gap:3px;height:28px;opacity:0;transition:opacity .3s;}
.waveform.active{opacity:1;}
.wave-bar{width:4px;background:var(--blue);border-radius:2px;animation:waveform .8s ease-in-out infinite;}
.wave-bar:nth-child(2){animation-delay:.1s;}
.wave-bar:nth-child(3){animation-delay:.2s;background:var(--teal);}
.wave-bar:nth-child(4){animation-delay:.3s;}
.wave-bar:nth-child(5){animation-delay:.4s;background:var(--purple);}
.wave-bar:nth-child(6){animation-delay:.1s;}
.wave-bar:nth-child(7){animation-delay:.25s;}
.mic-btn{width:84px;height:84px;border-radius:50%;border:none;cursor:pointer;color:#fff;background:linear-gradient(145deg,#1a9cf5,#0078d4);box-shadow:0 8px 24px rgba(0,120,212,.40),0 0 0 8px rgba(0,120,212,.10),inset 0 1px 0 rgba(255,255,255,.2);transition:all .3s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;justify-content:center;}
.mic-btn:hover{transform:scale(1.08) translateY(-2px);box-shadow:0 14px 32px rgba(0,120,212,.50),0 0 0 12px rgba(0,120,212,.10);}
.mic-btn.recording{background:linear-gradient(145deg,#e74c3c,#d13438);box-shadow:0 8px 24px rgba(209,52,56,.50),0 0 0 8px rgba(231,76,60,.15);animation:ripple 1.4s ease infinite;}
.mic-btn svg{width:32px;height:32px;fill:none;stroke:#fff;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;}
.mic-status{font-size:calc(var(--fs)-2px);color:var(--text2);font-weight:400;text-align:center;}
.transcript-box{width:100%;min-height:70px;padding:14px 16px;background:var(--bg2);border:1.5px solid var(--border);border-radius:10px;font-size:var(--fs);line-height:1.7;color:var(--text);font-style:italic;transition:all .3s;}

/* ‚îÄ‚îÄ Notices ‚îÄ‚îÄ */
.mic-notice{background:#fff8e0;border:1.5px solid var(--yellow);border-radius:10px;padding:12px 16px;font-size:calc(var(--fs)-1px);color:#7a5c00;margin-bottom:14px;display:none;text-align:center;line-height:1.6;}
.mic-notice.show{display:block;}
.browser-warn{background:#fff8e0;border:1.5px solid var(--yellow);border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:calc(var(--fs)-1px);color:#7a5c00;display:none;text-align:center;line-height:1.6;}
.browser-warn.show{display:block;}

/* ‚îÄ‚îÄ Feedback ‚îÄ‚îÄ */
.feedback-card{background:#fff;border:1.5px solid var(--border);border-radius:14px;padding:22px;margin-top:18px;animation:borderPulse 4s ease-in-out infinite,slideIn .4s ease;box-shadow:var(--shadow2);}
.feedback-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
.feedback-title{font-size:calc(var(--fs)+1px);font-weight:700;color:var(--blue);display:flex;align-items:center;gap:7px;}
.score-badge{padding:6px 18px;border-radius:20px;font-size:calc(var(--fs)+2px);font-weight:800;background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;box-shadow:0 2px 10px rgba(0,120,212,.3);}
.diff-wrong{color:#d13438;text-decoration:line-through;background:rgba(209,52,56,.10);padding:1px 4px;border-radius:3px;font-weight:600;}
.diff-correct{color:#107c10;background:rgba(16,124,16,.12);padding:1px 4px;border-radius:3px;font-weight:600;}
.diff-box{background:#fff;border:1.5px solid var(--border);border-left:4px solid var(--teal);border-radius:10px;padding:14px 16px;line-height:2.1;font-size:var(--fs);margin-bottom:14px;}
.corrected-text{background:var(--blue-xlt);padding:14px;border-radius:10px;line-height:1.8;font-size:var(--fs);margin-bottom:14px;border-left:4px solid var(--teal);}
.scores-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.score-item{padding:12px;background:var(--bg2);border-radius:10px;border:1.5px solid var(--border);transition:all .3s;}
.score-item:hover{border-color:var(--blue);box-shadow:var(--glow-b);}
.score-item-label{font-size:11px;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin-bottom:5px;}
.score-item-val{font-size:24px;font-weight:800;color:var(--blue);}
.score-item-comment{font-size:calc(var(--fs)-3px);color:var(--text3);margin-top:3px;}
.suggestion-box{padding:14px;background:linear-gradient(135deg,var(--teal-lt),#c8e8e4);border:1.5px solid #7accc6;border-radius:10px;}
.suggestion-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--teal);margin-bottom:7px;font-weight:700;}
.summary-text{font-size:calc(var(--fs)-2px);color:var(--text2);margin-top:12px;line-height:1.6;}
.hint-tag{display:inline-block;padding:2px 9px;font-size:11px;border-radius:4px;font-weight:600;margin-left:6px;}
.hint-tag.yes{background:#fffbe6;color:var(--yellow2);border:1px solid #f0cc6a;}
.hint-tag.no{background:var(--blue-xlt);color:var(--blue);border:1px solid #88b8e8;}

/* ‚îÄ‚îÄ Chat ‚îÄ‚îÄ */
.chat-container{height:380px;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px;background:var(--bg2);border-radius:12px;border:1.5px solid var(--border);margin-bottom:14px;}
.chat-bubble{max-width:82%;padding:12px 16px;border-radius:16px;font-size:var(--fs);line-height:1.65;animation:slideIn .3s ease;}
.chat-bubble.examiner{background:#fff;border:1.5px solid #88b8e8;border-bottom-left-radius:4px;align-self:flex-start;box-shadow:0 2px 8px rgba(0,60,130,.07);}
.chat-bubble.student{background:linear-gradient(135deg,var(--blue-xlt),var(--blue-lt));border:1.5px solid #88b8e8;border-bottom-right-radius:4px;align-self:flex-end;}
.bubble-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.bubble-label.examiner-label{color:var(--blue);}
.bubble-label.student-label{color:var(--teal);}
.cefr-badge{display:inline-block;padding:2px 7px;background:var(--blue-xlt);border-radius:10px;font-size:10px;color:var(--blue);font-weight:700;margin-left:6px;border:1px solid #88b8e8;}
.typing-dots{display:flex;gap:5px;padding:4px 0;}
.typing-dot{width:8px;height:8px;background:#88b8e8;border-radius:50%;animation:dotBounce 1.4s ease-in-out infinite;}
.typing-dot:nth-child(2){animation-delay:.2s;}
.typing-dot:nth-child(3){animation-delay:.4s;}

/* ‚îÄ‚îÄ Prep screen ‚îÄ‚îÄ */
.prep-screen{display:none;text-align:center;padding:50px 20px;}
.prep-screen.show{display:block;}
.prep-title{font-size:28px;font-weight:800;color:var(--blue);margin-bottom:10px;}
.prep-timer{font-size:88px;font-weight:900;color:var(--teal);line-height:1;margin:16px 0;}
.prep-note{color:var(--text2);font-size:var(--fs);}

/* ‚îÄ‚îÄ Review ‚îÄ‚îÄ */
.review-header{text-align:center;padding:28px;background:linear-gradient(135deg,var(--blue),var(--teal),var(--purple));background-size:250% 250%;animation:gradShift 5s ease infinite;border-radius:var(--radius);margin-bottom:22px;color:#fff;box-shadow:var(--shadow2);}
.final-score{font-size:72px;font-weight:900;line-height:1;text-shadow:0 3px 12px rgba(0,0,0,.22);}
.score-sub{opacity:.85;font-size:var(--fs);margin-top:6px;}
.review-item{background:#fff;border:1.5px solid var(--border);border-radius:14px;padding:22px;margin-bottom:16px;animation:fadeIn .5s ease;box-shadow:var(--shadow);}
.review-item-num{font-size:11px;color:var(--blue);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;font-weight:700;}
.review-question{font-size:calc(var(--fs)+1px);font-weight:700;margin-bottom:10px;}
.review-student{font-size:calc(var(--fs)-1px);color:var(--text2);padding:10px 12px;background:var(--bg2);border-radius:8px;margin-bottom:10px;font-style:italic;}
.review-corrected{font-size:calc(var(--fs)-1px);padding:12px 14px;background:#fff;border-left:3px solid var(--teal);border:1.5px solid var(--border);border-left:3px solid var(--teal);border-radius:0 8px 8px 0;margin-bottom:10px;line-height:2.1;}
.review-scores{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px;}
.review-score-chip{text-align:center;padding:8px 4px;background:var(--bg2);border-radius:8px;border:1px solid var(--border);}
.rscore-val{font-size:18px;font-weight:800;color:var(--blue);}
.rscore-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;}
.review-summary{font-size:calc(var(--fs)-2px);color:var(--text2);line-height:1.6;}
.mode-indicator{display:inline-flex;align-items:center;gap:7px;padding:5px 13px;border-radius:20px;background:var(--blue-xlt);border:1.5px solid #88b8e8;font-size:12px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px;}

/* ‚îÄ‚îÄ Sent notice ‚îÄ‚îÄ */
.sent-notice{background:linear-gradient(135deg,var(--green-lt),#c8e8c8);border:2px solid var(--green3);border-radius:12px;padding:18px 22px;margin-bottom:20px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 16px rgba(16,124,16,.12);}
.sent-notice-icon{font-size:36px;}
.sent-notice-text{font-size:var(--fs);font-weight:600;color:var(--green);}
.sent-notice-sub{font-size:calc(var(--fs)-2px);color:var(--text2);margin-top:3px;}

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(243,246,251,.92);z-index:400;display:none;align-items:center;justify-content:center;flex-direction:column;gap:18px;backdrop-filter:blur(4px);}
.loading-overlay.show{display:flex;}
.spinner{width:46px;height:46px;border:4px solid var(--bg3);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;}
.loading-text{color:var(--text2);font-size:var(--fs);font-weight:600;}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast{position:fixed;bottom:28px;right:24px;padding:13px 20px;border-radius:8px;font-size:var(--fs);font-weight:600;background:#fff;border:2px solid var(--border);box-shadow:var(--shadow2);z-index:500;transform:translateY(80px);opacity:0;transition:all .35s ease;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:var(--green);color:var(--green);}
.toast.error{border-color:var(--red);color:var(--red);}

@media(max-width:600px){
  .mode-grid,.scores-grid{grid-template-columns:1fr;}
  .review-scores{grid-template-columns:1fr 1fr;}
  .timer-value{font-size:44px;}
  .final-score{font-size:56px;}
  .zoom-bar{top:8px;right:8px;}
}
</style>
</head>
<body>

<div class="zoom-bar">
  <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
  <span class="zoom-val" id="zoomVal">100%</span>
  <button class="zoom-btn" onclick="zoomIn()">+</button>
</div>
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <p class="loading-text" id="loadingText">Loading...</p>
</div>
<div class="toast" id="toast"></div>

<div class="app">

<!-- PAGE 0: ACCESS CODE -->
<div class="page active" id="page0">
  <div class="app-header" style="text-align:center;padding:44px 28px 34px;">
    <h1 style="justify-content:center;">
      <span class="brand-icon">
        <!-- Speaking person SVG icon -->
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="10" cy="7" r="3" fill="white"/>
          <path d="M4 20c0-3.314 2.686-6 6-6s6 2.686 6 6" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M17 9c.8.8 1.3 1.9 1.3 3.1s-.5 2.3-1.3 3.1" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M19.5 7c1.3 1.3 2.1 3.1 2.1 5s-.8 3.7-2.1 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </span>
      Fluentalk
    </h1>
    <p style="margin-top:8px;opacity:.92;">IELTS Speaking Practice &amp; CEFR Test</p>
  </div>
  <div class="card glow-anim" style="max-width:420px;margin:0 auto;">
    <div class="card-title" style="justify-content:center;">üîê Enter Access Code</div>
    <p style="color:var(--text2);font-size:calc(var(--fs)-1px);margin-bottom:20px;text-align:center;line-height:1.6;">
      Please enter the access code provided by your teacher to continue.
    </p>
    <div style="margin-bottom:18px;">
      <label class="form-label">Access Code</label>
      <input type="text" class="form-input" id="accessCodeInput"
        placeholder="e.g. CLASS-A or DEMO2024"
        style="text-transform:uppercase;letter-spacing:2px;font-size:calc(var(--fs)+2px);text-align:center;font-weight:700;"
        onkeydown="if(event.key==='Enter')checkAccess()">
    </div>
    <div id="accessError" style="display:none;background:#fdf0f0;border:1.5px solid var(--red);border-radius:8px;padding:10px 14px;color:var(--red);font-size:calc(var(--fs)-1px);margin-bottom:14px;text-align:center;"></div>
    <button class="btn btn-primary btn-full" onclick="checkAccess()" id="accessBtn" style="padding:14px;font-size:calc(var(--fs)+1px);">
      ‚úÖ Verify &amp; Continue
    </button>
    <p style="text-align:center;margin-top:14px;font-size:11px;color:var(--text3);">Don't have a code? Contact your teacher.</p>
  </div>
</div>

<!-- PAGE 1: HOME -->
<div class="page" id="page1">
  <div class="app-header">
    <h1>
      <span class="brand-icon">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="10" cy="7" r="3" fill="white"/>
          <path d="M4 20c0-3.314 2.686-6 6-6s6 2.686 6 6" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M17 9c.8.8 1.3 1.9 1.3 3.1s-.5 2.3-1.3 3.1" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M19.5 7c1.3 1.3 2.1 3.1 2.1 5s-.8 3.7-2.1 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
      </span>
      Fluentalk
    </h1>
    <p>IELTS Speaking Practice &amp; CEFR Conversation Test</p>
  </div>
  <div class="card glow-anim">
    <div class="card-title">üë§ Student Information</div>
    <label class="form-label">Full Name</label>
    <input type="text" class="form-input" id="studentName" placeholder="Enter your full name...">
  </div>
  <div class="card">
    <div class="card-title">üéØ Select Practice Mode</div>
    <div class="mode-grid">
      <button class="mode-btn" onclick="selectMainMode('ielts',this)">
        <span class="mode-icon">üìã</span>
        <div class="mode-label">IELTS Speaking</div>
        <div class="mode-sub">Parts 1, 2, 3 &amp; Full Simulation</div>
      </button>
      <button class="mode-btn" onclick="selectMainMode('cefr',this)">
        <span class="mode-icon">üí¨</span>
        <div class="mode-label">CEFR Test</div>
        <div class="mode-sub">A1 ‚Üí B2 Progression</div>
      </button>
    </div>
    <div class="ielts-parts" id="ieltsParts">
      <button class="part-btn" onclick="selectPart('part1',this)">üìù Part 1<br><small>Introduction (3 sent.)</small></button>
      <button class="part-btn" onclick="selectPart('part2',this)">üó£Ô∏è Part 2<br><small>Long Turn (10-12 sent.)</small></button>
      <button class="part-btn" onclick="selectPart('part3',this)">üí° Part 3<br><small>Discussion (5-6 sent.)</small></button>
      <button class="part-btn" onclick="selectPart('simulation',this)">üé≠ Full Simulation<br><small>Complete IELTS Test</small></button>
    </div>
    <div class="sim-modes" id="simModes">
      <button class="sim-opt" onclick="selectSimMode('custom',this)">
        <span style="font-size:20px;">‚úçÔ∏è</span>
        <div><div style="font-weight:700;">Custom Questions</div><div style="font-size:12px;color:var(--text3);margin-top:2px;">Add your own Part 1, 2, 3 questions</div></div>
      </button>
      <button class="sim-opt" onclick="selectSimMode('forecast',this)">
        <span style="font-size:20px;">üìä</span>
        <div><div style="font-weight:700;">Forecast Test</div><div style="font-size:12px;color:var(--text3);margin-top:2px;">Paste a question bank ‚Äî random selection</div></div>
      </button>
    </div>
  </div>
  <button class="btn btn-primary btn-full" onclick="goToSetup()" style="font-size:calc(var(--fs)+1px);padding:16px;">
    ‚û°Ô∏è Continue to Setup
  </button>
</div>

<!-- PAGE 1.5: SETUP -->
<div class="page" id="page15">
  <div class="app-header">
    <h1>
      <span class="brand-icon">
        <svg viewBox="0 0 24 24" fill="none"><circle cx="10" cy="7" r="3" fill="white"/><path d="M4 20c0-3.314 2.686-6 6-6s6 2.686 6 6" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M17 9c.8.8 1.3 1.9 1.3 3.1s-.5 2.3-1.3 3.1" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M19.5 7c1.3 1.3 2.1 3.1 2.1 5s-.8 3.7-2.1 5" stroke="white" stroke-width="1.8" stroke-linecap="round"/></svg>
      </span>
      <span id="setupTitle">Setup</span>
    </h1>
    <p id="setupSubtitle">Prepare your questions and answers</p>
  </div>
  <div id="setupContent"></div>
  <div class="btn-group" style="margin-top:8px;">
    <button class="btn btn-ghost" onclick="goToPage(1)">‚Üê Back</button>
    <button class="btn btn-primary btn-full" onclick="startSession()" style="font-size:calc(var(--fs)+1px);padding:16px;">üöÄ Start Session</button>
  </div>
</div>

<!-- PAGE 2: PRACTICE -->
<div class="page" id="page2">
  <div class="prep-screen" id="prepScreen">
    <div class="prep-title">‚è∏Ô∏è Preparation Time</div>
    <p class="prep-note">You have 60 seconds to prepare for Part 2</p>
    <div class="prep-timer" id="prepTimer">60</div>
    <p class="prep-note">Part 2 will begin automatically...</p>
  </div>
  <div id="practiceArea">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:8px;">
      <div>
        <div class="mode-indicator" id="modeIndicator">üìã IELTS Part 1</div>
        <div style="font-size:calc(var(--fs)-2px);color:var(--text2);" id="studentHeader"></div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="confirmEnd()">‚èπ End Session</button>
    </div>
    <div class="progress-area" id="progressArea">
      <div class="progress-label"><span id="progressLabel">Question 1 of 5</span><span id="progressPct">0%</span></div>
      <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    </div>
    <div class="timer-display" id="timerDisplay" style="display:none;">
      <div class="timer-label" id="timerLabel">TIME REMAINING</div>
      <div class="timer-value" id="timerValue">00:00</div>
      <div class="timer-bar"><div class="timer-bar-fill" id="timerBarFill" style="width:100%"></div></div>
    </div>
    <div id="chatMode" style="display:none;">
      <div class="chat-container" id="chatContainer"></div>
    </div>
    <div id="standardMode">
      <div class="question-display">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
          <div style="flex:1;">
            <div class="question-num" id="questionNum">QUESTION 1</div>
            <div class="question-text" id="questionText">Loading...</div>
          </div>
          <button onclick="speakText(document.getElementById('questionText').textContent)" title="Read question aloud" id="speakBtn" style="flex-shrink:0;margin-top:4px;width:36px;height:36px;border-radius:50%;border:1.5px solid rgba(0,120,212,.3);background:rgba(255,255,255,.8);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;">
            <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:none;stroke:var(--blue);stroke-width:2;stroke-linecap:round;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
          </button>
        </div>
      </div>
      <div class="hint-toggle" id="hintToggle">
        <button class="hint-opt active" id="hintNone" onclick="setHint('none')">üó£Ô∏è Answer without hints</button>
        <button class="hint-opt" id="hintKw" onclick="setHint('keywords')">üí° Show my key words</button>
      </div>
      <div class="keywords-box" id="keywordsBox">
        <div class="keywords-label">üí° Key Words</div>
        <div class="kw-chips" id="kwChips" style="margin-bottom:10px;min-height:28px;"></div>
        <div style="display:flex;gap:7px;">
          <input type="text" id="kwInput" class="form-input"
            placeholder="Add more words..."
            style="flex:1;padding:7px 11px;font-size:calc(var(--fs)-1px);"
            onkeydown="if(event.key==='Enter'){event.preventDefault();addKwChip();}">
          <button onclick="addKwChip()" style="padding:7px 14px;border-radius:8px;border:none;background:var(--blue);color:#fff;font-size:18px;font-weight:700;cursor:pointer;line-height:1;flex-shrink:0;">+</button>
        </div>
      </div>
    </div>
    <div class="mic-notice" id="micNotice">
      ‚ö†Ô∏è Microphone access was denied.<br>
      Please click the <b>üîí lock icon</b> in your browser's address bar ‚Üí <b>Allow Microphone</b> ‚Üí then refresh.
    </div>
    <div class="browser-warn" id="browserWarn">
      ‚ö†Ô∏è <b>Microsoft Edge</b> kh√¥ng h·ªó tr·ª£ nh·∫≠n gi·ªçng n√≥i t·ªët. Vui l√≤ng d√πng <b>Google Chrome</b> ho·∫∑c <b>Safari</b> ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ t·ªët nh·∫•t.
    </div>
    <div class="mic-area">
      <div class="waveform" id="waveform">
        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
      </div>
      <button class="mic-btn" id="micBtn" onclick="toggleRecording()" title="Click to record (or press Space)">
        <svg viewBox="0 0 24 24" id="micIcon" style="width:32px;height:32px;fill:none;stroke:#fff;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;">
          <rect x="9" y="2" width="6" height="12" rx="3"/>
          <path d="M5 10a7 7 0 0 0 14 0"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="8" y1="22" x2="16" y2="22"/>
        </svg>
      </button>
      <div class="mic-status" id="micStatus">Tap to start speaking &nbsp;|&nbsp;
        <kbd style="background:var(--bg2);padding:2px 7px;border-radius:4px;border:1px solid var(--border);font-size:12px;">Space</kbd>
      </div>
    </div>
    <div style="margin-bottom:14px;">
      <label class="form-label" style="margin-bottom:7px;">Your Answer:</label>
      <div class="transcript-box" id="transcriptBox">Your speech will appear here...</div>
    </div>
    <div class="btn-group" style="margin-bottom:18px;">
      <button class="btn btn-success" id="submitBtn" onclick="submitAnswer()" style="flex:1;">‚úÖ Submit Answer</button>
      <button class="btn btn-ghost" onclick="clearTranscript()">üóë Clear</button>
    </div>
    <div id="feedbackArea"></div>
    <button class="btn btn-primary btn-full" id="nextBtn" onclick="nextQuestion()" style="display:none;margin-top:14px;">Next Question ‚Üí</button>
  </div>
</div>

<!-- PAGE 3: REVIEW -->
<div class="page" id="page3">
  <div class="sent-notice">
    <div class="sent-notice-icon">‚úÖ</div>
    <div>
      <div class="sent-notice-text">Your result has been sent to your teacher!</div>
      <div class="sent-notice-sub">Results are saved automatically when you end the session.</div>
    </div>
  </div>
  <div class="review-header">
    <div style="font-size:12px;opacity:.8;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">Final Score</div>
    <div class="final-score" id="finalScore">--</div>
    <div class="score-sub" id="finalScoreSub">Average IELTS Band Score</div>
    <div style="display:flex;justify-content:center;gap:24px;margin-top:18px;flex-wrap:wrap;" id="breakdownSummary"></div>
  </div>
  <div class="btn-group" style="margin-bottom:20px;">
    <button class="btn btn-primary" onclick="toggleReview()" id="reviewToggleBtn" style="flex:1;">üìã Review My Answers</button>
    <button class="btn btn-ghost" onclick="restartApp()" style="flex:1;">üîÑ New Session</button>
  </div>
  <div id="reviewList" style="display:none;"></div>
</div>

</div><!-- .app -->

<script>
var GAS_URL = 'https://script.google.com/macros/s/AKfycbwQ6Ue7QWPzLz9oAQPmR4ZG7ZuMagfwFFH6OUCw6foRw8JVaPzofwxtSqytAKlToGfx/exec';

// ========== GAS JSONP CALLER ==========
function gasCall(funcName, params, onSuccess, onFailure) {
  var url = GAS_URL + '?func=' + encodeURIComponent(funcName);
  if (params !== undefined && params !== null) url += '&params=' + encodeURIComponent(JSON.stringify(params));
  var cb = 'gasCallback_' + Date.now() + '_' + Math.floor(Math.random() * 9999);
  url += '&callback=' + cb;
  var script = document.createElement('script');
  script.src = url;
  var timer = setTimeout(function() { cleanup(); if (onFailure) onFailure({ message: 'Request timeout.' }); }, 30000);
  window[cb] = function(result) { cleanup(); if (result && result.__error) { if (onFailure) onFailure({ message: result.__error }); } else { if (onSuccess) onSuccess(result); } };
  function cleanup() { clearTimeout(timer); delete window[cb]; if (script.parentNode) script.parentNode.removeChild(script); }
  script.onerror = function() { cleanup(); if (onFailure) onFailure({ message: 'Network error. Check GAS_URL.' }); };
  document.head.appendChild(script);
}

// ========== ZOOM ==========
var zoomLevel = 100;
function zoomIn() { if (zoomLevel >= 140) return; zoomLevel += 10; applyZoom(); }
function zoomOut() { if (zoomLevel <= 70) return; zoomLevel -= 10; applyZoom(); }
function applyZoom() { document.documentElement.style.setProperty('--fs', (zoomLevel / 100 * 15) + 'px'); document.getElementById('zoomVal').textContent = zoomLevel + '%'; }

// ========== DATE FORMAT DD-MM-YYYY @ HH:MM (UTC+7) ==========
function formatDateTime(date) {
  var d = date instanceof Date ? date : new Date(date);
  var utc = d.getTime() + (d.getTimezoneOffset() * 60000);
  var vn = new Date(utc + 7 * 60 * 60000);
  var dd = String(vn.getDate()).padStart(2,'0'), mm = String(vn.getMonth()+1).padStart(2,'0');
  var hh = String(vn.getHours()).padStart(2,'0'), min = String(vn.getMinutes()).padStart(2,'0');
  return dd+'-'+mm+'-'+vn.getFullYear()+' @ '+hh+':'+min;
}

// ========== DIFF HIGHLIGHT ==========
function buildDiffHtml(original, corrected) {
  if (!original || !corrected) return corrected || original || '';
  var oW = original.trim().split(/\s+/), cW = corrected.trim().split(/\s+/);
  var m = oW.length, n = cW.length, dp = [];
  for (var i = 0; i <= m; i++) { dp[i] = []; for (var j = 0; j <= n; j++) dp[i][j] = 0; }
  for (var i = 1; i <= m; i++) for (var j = 1; j <= n; j++) {
    if (oW[i-1].toLowerCase().replace(/[^a-z0-9]/g,'') === cW[j-1].toLowerCase().replace(/[^a-z0-9]/g,'')) dp[i][j] = dp[i-1][j-1]+1;
    else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
  }
  var ops = [], i = m, j = n;
  while (i > 0 || j > 0) {
    if (i > 0 && j > 0 && oW[i-1].toLowerCase().replace(/[^a-z0-9]/g,'') === cW[j-1].toLowerCase().replace(/[^a-z0-9]/g,'')) { ops.unshift({type:'equal',orig:oW[i-1],corr:cW[j-1]}); i--; j--; }
    else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) { ops.unshift({type:'insert',corr:cW[j-1]}); j--; }
    else { ops.unshift({type:'delete',orig:oW[i-1]}); i--; }
  }
  var merged = [];
  for (var k = 0; k < ops.length; k++) {
    if (ops[k].type === 'delete' && k+1 < ops.length && ops[k+1].type === 'insert') { merged.push({type:'replace',orig:ops[k].orig,corr:ops[k+1].corr}); k++; } else merged.push(ops[k]);
  }
  return merged.map(function(op) {
    if (op.type === 'equal') return op.corr;
    if (op.type === 'replace') return '<span class="diff-wrong">'+op.orig+'</span> <span class="diff-correct">'+op.corr+'</span>';
    if (op.type === 'delete') return '<span class="diff-wrong">'+op.orig+'</span>';
    if (op.type === 'insert') return '<span class="diff-correct">'+op.corr+'</span>';
    return '';
  }).join(' ');
}

// ========== BROWSER CHECK ==========
function checkBrowser() {
  var ua = navigator.userAgent;
  if (/Edg\//.test(ua) || /Edge\//.test(ua)) { var w = document.getElementById('browserWarn'); if (w) w.classList.add('show'); }
}
checkBrowser();

// ========== STATE ==========
var state = { studentName:'', mode:'', simMode:'', accessCode:'', questions:[], currentIndex:0, results:[], startingTime:null, recognition:null, isRecording:false, transcript:'', timerInterval:null, timerSeconds:0, timerStarted:false, cefrLevel:'A1', cefrHistory:[], sessionEnded:false, hintMode:'none', p1Count:10, p2Count:1, p3Count:6, _prepDone:false };
var cefrLevels = ['A1','A1','A2','A2','B1','B1','B2','B2'];
var setupData = { part1:[], part2:[], part3:[], forecast:'', simMode:'' };

// ========== ACCESS CODE ==========
function checkAccess() {
  var code = document.getElementById('accessCodeInput').value.trim().toUpperCase();
  var errEl = document.getElementById('accessError'), btn = document.getElementById('accessBtn');
  if (!code) { errEl.textContent = 'Please enter your access code.'; errEl.style.display = 'block'; return; }
  errEl.style.display = 'none'; btn.disabled = true; btn.textContent = 'Verifying...';
  gasCall('validateAccessCode', code,
    function(res) {
      btn.disabled = false; btn.textContent = '‚úÖ Verify & Continue';
      if (res && res.valid) { state.accessCode = code; showToast('Welcome! Access granted ‚úÖ', 'success'); goToPage(1); }
      else { errEl.textContent = (res && res.message) || 'Invalid code.'; errEl.style.display = 'block'; document.getElementById('accessCodeInput').select(); }
    },
    function(e) { btn.disabled = false; btn.textContent = '‚úÖ Verify & Continue'; errEl.textContent = 'Connection error: ' + (e.message || 'Try again.'); errEl.style.display = 'block'; }
  );
}

// ========== MODE SELECT ==========
function selectMainMode(mode, el) {
  document.querySelectorAll('.mode-btn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected'); state.mode = (mode === 'ielts') ? '' : mode;
  document.getElementById('ieltsParts').classList.toggle('show', mode === 'ielts');
  document.getElementById('simModes').classList.remove('show');
  document.querySelectorAll('.part-btn,.sim-opt').forEach(function(b){b.classList.remove('selected');});
}
function selectPart(part, el) {
  document.querySelectorAll('.part-btn').forEach(function(b){b.classList.remove('selected');});
  el.classList.add('selected'); state.mode = part;
  document.getElementById('simModes').classList.toggle('show', part === 'simulation');
  if (part !== 'simulation') { state.simMode = ''; document.querySelectorAll('.sim-opt').forEach(function(b){b.classList.remove('selected');}); }
}
function selectSimMode(sm, el) { document.querySelectorAll('.sim-opt').forEach(function(b){b.classList.remove('selected');}); el.classList.add('selected'); state.simMode = sm; }

// ========== SETUP ==========
function goToSetup() {
  var n = document.getElementById('studentName').value.trim();
  if (!n) { showToast('Please enter your name!', 'error'); return; }
  if (!state.mode) { showToast('Please select a practice mode!', 'error'); return; }
  if (state.mode === 'simulation' && !state.simMode) { showToast('Please select a simulation type!', 'error'); return; }
  state.studentName = n; buildSetup(); goToPage(15);
}
function buildSetup() {
  var content = document.getElementById('setupContent'); content.innerHTML = '';
  var titles = { part1:'üìù Part 1 Setup', part2:'üó£Ô∏è Part 2 Setup', part3:'üí° Part 3 Setup', simulation:'üé≠ Full Simulation Setup', cefr:'üí¨ CEFR Test' };
  document.getElementById('setupTitle').textContent = titles[state.mode] || 'Setup';
  if (state.mode === 'cefr') {
    document.getElementById('setupSubtitle').textContent = 'Questions are generated automatically by the examiner';
    content.innerHTML = '<div class="card" style="text-align:center;padding:34px;"><div style="font-size:48px;margin-bottom:14px;">üë§</div><div style="font-size:calc(var(--fs)+2px);font-weight:700;color:var(--blue);margin-bottom:8px;">Examiner will guide the conversation</div><div style="color:var(--text2);line-height:1.7;">Questions start at A1 level and gradually increase to B2.<br>Just speak naturally and the examiner will respond.</div></div>';
    return;
  }
  if (state.mode === 'part1' || state.mode === 'part2' || state.mode === 'part3') {
    document.getElementById('setupSubtitle').textContent = 'Add your questions below';
    var defaultQs = getDefaults(state.mode);
    setupData[state.mode] = defaultQs.map(function(q){return{q:q,a:'',kw:[]};});
    renderPartSetup(content, state.mode, false); return;
  }
  if (state.simMode === 'custom') {
    document.getElementById('setupSubtitle').textContent = 'Add questions for each part';
    setupData.part1 = [{q:'',a:'',kw:[]},{q:'',a:'',kw:[]}]; setupData.part2 = [{q:'',a:'',kw:[]}]; setupData.part3 = [{q:'',a:'',kw:[]},{q:'',a:'',kw:[]}];
    ['part1','part2','part3'].forEach(function(p){renderPartSetup(content,p,true);});
  } else if (state.simMode === 'forecast') {
    document.getElementById('setupSubtitle').textContent = 'Paste forecast questions by part';
    var fc = document.createElement('div');
    fc.innerHTML = '<div class="setup-part-section"><div class="setup-part-title">üìù Part 1 ‚Äî Introduction Questions</div><textarea class="forecast-area" id="forecastP1" style="min-height:120px;" placeholder="Do you live in a house or apartment?\nWhat do you do in your free time?"></textarea></div><div class="setup-part-section"><div class="setup-part-title">üó£Ô∏è Part 2 ‚Äî Cue Card Topics</div><textarea class="forecast-area" id="forecastP2" style="min-height:120px;" placeholder="Describe a person who inspired you.\nDescribe a place you love visiting."></textarea></div><div class="setup-part-section"><div class="setup-part-title">üí° Part 3 ‚Äî Discussion Questions</div><textarea class="forecast-area" id="forecastP3" style="min-height:120px;" placeholder="How has technology changed communication?"></textarea></div>';
    content.appendChild(fc);
  }
}
function renderPartSetup(container, part, showTitle) {
  var titles = { part1:'Part 1 ‚Äî Introduction', part2:'Part 2 ‚Äî Long Turn (Cue Card)', part3:'Part 3 ‚Äî Discussion' };
  var section = document.createElement('div'); section.className = 'setup-part-section';
  if (showTitle) section.innerHTML = '<div class="setup-part-title">'+titles[part]+'</div>';
  else { section.innerHTML = ''; document.getElementById('setupSubtitle').textContent = 'Add your question and optional sample answer'; }
  var rowsContainer = document.createElement('div'); rowsContainer.id = 'rows_'+part;
  section.appendChild(rowsContainer); container.appendChild(section); renderPartRows(part);
  if (part !== 'part2') {
    var addBtn = document.createElement('button'); addBtn.className = 'add-q-btn'; addBtn.textContent = '+ Add Another Question';
    addBtn.onclick = function(){setupData[part].push({q:'',a:'',kw:[]});renderPartRows(part);};
    section.appendChild(addBtn);
  }
}
function renderPartRows(part) {
  var lens = { part1:'3 sentences', part2:'10-12 sentences', part3:'5-6 sentences' };
  var container = document.getElementById('rows_'+part); if (!container) return; container.innerHTML = '';
  setupData[part].forEach(function(item, i) {
    var row = document.createElement('div'); row.className = 'q-row';
    row.style.cssText = 'display:flex;flex-direction:column;gap:10px;';
    var kwVal = (item.userKw||[]).join(', ');
    row.innerHTML =
      // Question
      '<div class="q-input-wrap"><label>üìå Question '+(i+1)+'</label>'
      +'<textarea id="q_'+part+'_'+i+'" placeholder="Add your question here..." onchange="syncQ(\''+part+'\','+i+')">'+esc(item.q)+'</textarea></div>'
      // Sample Answer
      +'<div class="a-input-wrap"><label><span class="a-label-text">‚úèÔ∏è Sample Answer <small style="font-size:10px;color:var(--text3);">('+lens[part]+')</small></span>'
      +'<button class="sample-btn" onclick="getSample(\''+part+'\','+i+')">‚ú® Generate</button></label>'
      +'<textarea id="a_'+part+'_'+i+'" placeholder="Optional: add your own answer or click ‚ú® Generate" onchange="syncA(\''+part+'\','+i+')">'+esc(item.a)+'</textarea></div>'
      // Keywords
      +'<div style="background:linear-gradient(135deg,#fffbe6,#fff5cc);border:1.5px solid #f0cc6a;border-radius:10px;padding:12px 14px;">'
      +'<div style="font-size:11px;font-weight:700;color:var(--yellow2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;">üí° Key Words <small style="font-weight:400;color:var(--text3);text-transform:none;letter-spacing:0;">(sinh vi√™n t·ª± th√™m t·ª´ mu·ªën d√πng khi n√≥i)</small></div>'
      +'<div style="display:flex;gap:7px;margin-bottom:8px;">'
      +'<input type="text" id="kwSetupInput_'+part+'_'+i+'" placeholder="Nh·∫≠p t·ª´ kho√° r·ªìi nh·∫•n Enter ho·∫∑c +" style="flex:1;padding:7px 11px;border:1.5px solid #f0cc6a;border-radius:7px;font-family:var(--font);font-size:calc(var(--fs)-1px);background:#fff;outline:none;" onkeydown="if(event.key===\'Enter\'){event.preventDefault();addSetupKw(\''+part+'\','+i+');}">'
      +'<button onclick="addSetupKw(\''+part+'\','+i+')" style="padding:7px 13px;border-radius:7px;border:none;background:var(--yellow2);color:#fff;font-size:18px;font-weight:700;cursor:pointer;line-height:1;">+</button>'
      +'</div>'
      +'<div id="kwSetupChips_'+part+'_'+i+'" style="display:flex;flex-wrap:wrap;gap:6px;min-height:24px;">'
      +(kwVal ? renderSetupChipsHtml(item.userKw||[], part, i) : '<span style="color:var(--text3);font-size:12px;">Ch∆∞a c√≥ t·ª´ n√†o ‚Äî h√£y th√™m v√†o</span>')
      +'</div>'
      +'</div>';
    container.appendChild(row);
  });
}

function renderSetupChipsHtml(kws, part, i) {
  if(!kws||!kws.length) return '<span style="color:var(--text3);font-size:12px;">Ch∆∞a c√≥ t·ª´ n√†o ‚Äî h√£y th√™m v√†o</span>';
  var colors = ['#0078d4','#008272','#5c2d91','#d83b01','#107c10'];
  return kws.map(function(k, ci){
    var safe = k.replace(/'/g,"\\'");
    return '<span onclick="removeSetupKw(\''+part+'\','+i+',\''+safe+'\')" title="Click to remove" '
      +'style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;background:'+colors[ci%colors.length]+';color:#fff;font-size:12px;font-weight:600;cursor:pointer;">'
      +k+' <span style="opacity:.65;font-size:10px;">‚úï</span></span>'
      +(ci < kws.length-1 ? '<span style="color:var(--text3);font-size:14px;font-weight:700;line-height:1;align-self:center;">‚Üí</span>' : '');
  }).join('');
}

function addSetupKw(part, i) {
  var input = document.getElementById('kwSetupInput_'+part+'_'+i);
  var val = (input.value||'').trim();
  if(!val) return;
  if(!setupData[part][i].userKw) setupData[part][i].userKw = [];
  if(!setupData[part][i].userKw.some(function(k){ return k.toLowerCase()===val.toLowerCase(); })){
    setupData[part][i].userKw.push(val);
  }
  input.value = ''; input.focus();
  var chips = document.getElementById('kwSetupChips_'+part+'_'+i);
  if(chips) chips.innerHTML = renderSetupChipsHtml(setupData[part][i].userKw, part, i);
}

function removeSetupKw(part, i, word) {
  if(!setupData[part][i]) return;
  setupData[part][i].userKw = (setupData[part][i].userKw||[]).filter(function(k){ return k!==word; });
  var chips = document.getElementById('kwSetupChips_'+part+'_'+i);
  if(chips) chips.innerHTML = renderSetupChipsHtml(setupData[part][i].userKw, part, i);
}
function syncQ(part,i){var el=document.getElementById('q_'+part+'_'+i);if(el&&setupData[part][i])setupData[part][i].q=el.value;}
function syncA(part,i){var el=document.getElementById('a_'+part+'_'+i);if(el&&setupData[part][i])setupData[part][i].a=el.value;}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function getSample(part,i) {
  syncQ(part,i); var item = setupData[part][i];
  if (!item||!item.q.trim()){showToast('Please enter a question first!','error');return;}
  var lens = {part1:'exactly 3 sentences',part2:'10 to 12 sentences',part3:'5 to 6 sentences'};

  // Show inline spinner on the button instead of full-screen overlay
  var btn = document.querySelector('#rows_'+part+' .q-row:nth-child('+(i+1)+') .sample-btn');
  if(btn){ btn.textContent='‚è≥ Generating...'; btn.disabled=true; }
  var aEl = document.getElementById('a_'+part+'_'+i);
  if(aEl){ aEl.placeholder='‚úçÔ∏è AI is writing your sample answer...'; aEl.style.borderColor='var(--blue)'; }

  gasCall('getSampleAnswer',[item.q.trim(),lens[part]||'3 sentences'],
    function(txt){
      if(btn){ btn.textContent='‚ú® Generate'; btn.disabled=false; }
      if(aEl){
        aEl.value=(txt||'').trim();
        setupData[part][i].a=(txt||'').trim();
        aEl.placeholder='Optional: add your own answer or click ‚ú® Generate';
        aEl.style.borderColor='var(--teal)';
        setTimeout(function(){ aEl.style.borderColor=''; },2000);
      }
      showToast('‚úÖ Sample answer generated!','success');
    },
    function(e){
      if(btn){ btn.textContent='‚ú® Generate'; btn.disabled=false; }
      if(aEl){ aEl.placeholder='Optional: add your own answer or click ‚ú® Generate'; aEl.style.borderColor=''; }
      showToast('Error: '+e.message,'error');
    }
  );
}
function getDefaults(mode) {
  var d = { part1:['Can you tell me about your hometown?','What do you do in your free time?','Do you prefer indoor or outdoor activities?'], part2:['Describe a person who has greatly influenced you. You should say: who this person is, how you know them, what qualities they have, and explain why they have influenced you so much.'], part3:['How important is it for young people to have role models?','Do you think family influence is stronger than peer influence?','What qualities make a good leader?'] };
  return d[mode]||[];
}

// ========== START SESSION ==========
function startSession() {
  state.startingTime = new Date().toISOString();
  state.results=[]; state.currentIndex=0; state.cefrHistory=[]; state.cefrLevel='A1'; state.sessionEnded=false; state.hintMode='none';
  if (state.mode==='cefr'){state.questions=[];goToPage(2);initPage2();return;}
  if (state.mode==='part1'||state.mode==='part2'||state.mode==='part3'){
    setupData[state.mode].forEach(function(item,i){syncQ(state.mode,i);syncA(state.mode,i);});
    state.questions=setupData[state.mode].filter(function(d){return d.q.trim();});
    // Carry userKw from setup into questions
    state.questions.forEach(function(q){ q.userKw = q.userKw || []; });
    if(!state.questions.length)state.questions=getDefaults(state.mode).map(function(q){return{q:q,a:'',userKw:[]};});
    batchKeywordsAndStart();return;
  }
  if (state.simMode==='forecast'){
    function parseLines(id){var el=document.getElementById(id);if(!el||!el.value.trim())return[];return el.value.split('\n').map(function(l){return l.replace(/^[\d]+[\.\)\s]+/,'').trim();}).filter(Boolean);}
    var p1l=parseLines('forecastP1'),p2l=parseLines('forecastP2'),p3l=parseLines('forecastP3');
    if(!p1l.length&&!p2l.length&&!p3l.length){showToast('Please add questions!','error');return;}
    shuffle(p1l);shuffle(p2l);shuffle(p3l);
    var p1=(p1l.length?p1l.slice(0,10):getDefaults('part1')).map(function(q){return{q:q,a:'',kw:[]};});
    var p2=(p2l.length?p2l.slice(0,1):getDefaults('part2')).map(function(q){return{q:q,a:'',kw:[]};});
    var p3=(p3l.length?p3l.slice(0,6):getDefaults('part3')).map(function(q){return{q:q,a:'',kw:[]};});
    state.p1Count=p1.length;state.p2Count=p2.length;state.p3Count=p3.length;state._prepDone=false;
    state.questions=p1.concat(p2).concat(p3);batchKeywordsAndStart('simulation');return;
  }
  if (state.simMode==='custom'){
    ['part1','part2','part3'].forEach(function(p){setupData[p].forEach(function(item,i){syncQ(p,i);syncA(p,i);});});
    var p1c=setupData.part1.filter(function(d){return d.q.trim();}).slice(0,10);
    var p2c=setupData.part2.filter(function(d){return d.q.trim();}).slice(0,1);
    var p3c=setupData.part3.filter(function(d){return d.q.trim();}).slice(0,6);
    // Carry userKw from setup
    [p1c,p2c,p3c].forEach(function(arr){ arr.forEach(function(q){ q.userKw = q.userKw||[]; }); });
    state.p1Count=p1c.length;state.p2Count=p2c.length;state.p3Count=p3c.length;state._prepDone=false;
    state.questions=p1c.concat(p2c).concat(p3c);
    if(!state.questions.length){showToast('Please add at least one question!','error');return;}
    batchKeywordsAndStart('simulation');return;
  }
}
function shuffle(arr){for(var i=arr.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=arr[i];arr[i]=arr[j];arr[j]=t;}return arr;}
function batchKeywordsAndStart(modeOverride){
  // Keywords are now user-defined ‚Äî no AI call needed, start immediately
  goToPage(2); initPage2();
}

// ========== PAGE 2 INIT ==========
function initPage2(){
  var labels={part1:'üìù IELTS Part 1',part2:'üó£Ô∏è IELTS Part 2',part3:'üí° IELTS Part 3',simulation:'üé≠ Full Simulation',cefr:'üí¨ CEFR Test'};
  document.getElementById('modeIndicator').textContent=labels[state.mode]||state.mode;
  document.getElementById('studentHeader').textContent='Student: '+state.studentName;
  document.getElementById('feedbackArea').innerHTML=''; document.getElementById('nextBtn').style.display='none'; clearTranscript();
  if(state.mode==='cefr'){document.getElementById('chatMode').style.display='block';document.getElementById('standardMode').style.display='none';document.getElementById('progressArea').style.display='none';document.getElementById('timerDisplay').style.display='block';document.getElementById('hintToggle').style.display='none';startTimer('countup',600);startCEFR();}
  else{document.getElementById('chatMode').style.display='none';document.getElementById('standardMode').style.display='block';document.getElementById('hintToggle').style.display='flex';loadQ(0);}
}
function showPrepForP2(onDone){
  var prep=document.getElementById('prepScreen'),pa=document.getElementById('practiceArea');
  prep.classList.add('show');pa.style.display='none';
  var s=60;document.getElementById('prepTimer').textContent=s;
  var iv=setInterval(function(){s--;document.getElementById('prepTimer').textContent=s;if(s<=0){clearInterval(iv);prep.classList.remove('show');pa.style.display='block';if(onDone)onDone();}},1000);
}

// ========== TTS ‚Äî Reliable, always plays ==========
var ttsAudio = null, ttsCache = {}, _ttsQueue = [];

function speakText(text){
  var clean = (text||'').replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim();
  if(!clean || clean.length < 2) return;
  // Limit to first 300 chars so TTS is fast
  if(clean.length > 300) clean = clean.substring(0, 300);
  stopSpeaking();
  if(ttsCache[clean]){ _playBase64(ttsCache[clean]); return; }
  var sb = document.getElementById('speakBtn');
  if(sb){ sb.style.opacity='.5'; sb.style.pointerEvents='none'; }
  // Retry once on failure
  function doCall(attempt){
    gasCall('getTTS',[clean,'nova'],
      function(res){
        if(sb){ sb.style.opacity='1'; sb.style.pointerEvents='auto'; }
        if(res && res.success && res.audio){
          ttsCache[clean] = res.audio;
          _playBase64(res.audio);
        }
      },
      function(){
        if(attempt < 2){
          setTimeout(function(){ doCall(attempt+1); }, 1000);
        } else {
          if(sb){ sb.style.opacity='1'; sb.style.pointerEvents='auto'; }
        }
      }
    );
  }
  doCall(1);
}

function _playBase64(b64){
  try{
    stopSpeaking();
    var bytes = atob(b64), arr = new Uint8Array(bytes.length);
    for(var j=0;j<bytes.length;j++) arr[j]=bytes.charCodeAt(j);
    var url = URL.createObjectURL(new Blob([arr],{type:'audio/mpeg'}));
    ttsAudio = new Audio(url);
    // Chrome autoplay policy: must be triggered after user interaction
    // We use a short timeout and catch the rejection gracefully
    var playPromise = ttsAudio.play();
    if(playPromise !== undefined){
      playPromise.catch(function(err){
        // Autoplay blocked ‚Äî silently ignore, user can click speaker icon
        console.log('TTS autoplay blocked:', err.message);
      });
    }
    ttsAudio.onended = function(){ ttsAudio = null; };
  }catch(e){ ttsAudio = null; }
}

function stopSpeaking(){
  if(ttsAudio){ try{ ttsAudio.pause(); URL.revokeObjectURL(ttsAudio.src); }catch(x){} ttsAudio=null; }
}

function loadQ(idx){
  if(idx>=state.questions.length){endSession();return;}
  if(state.mode==='simulation'&&idx===state.p1Count&&!state._prepDone){state._prepDone=true;showPrepForP2(function(){_doLoadQ(idx);});return;}
  _doLoadQ(idx);
}
function _doLoadQ(idx){
  state.currentIndex=idx; var item=state.questions[idx]; stopTimer();
  document.getElementById('questionNum').textContent='QUESTION '+(idx+1);
  document.getElementById('questionText').textContent=item.q;
  updateProgress(idx,state.questions.length);
  document.getElementById('feedbackArea').innerHTML=''; document.getElementById('nextBtn').style.display='none';
  document.getElementById('timerDisplay').style.display='none'; clearTranscript();

  // Auto-show keywords if this question has any, otherwise hide
  var hasKw = ((item.userKw && item.userKw.length) || (item.runtimeKw && item.runtimeKw.length));
  setHint(hasKw ? 'keywords' : 'none');

  if(state.mode==='simulation'){
    var lbl='';
    if(idx<state.p1Count)lbl='üìù Part 1 ‚Äî Q'+(idx+1)+'/'+state.p1Count;
    else if(idx<state.p1Count+state.p2Count)lbl='üó£Ô∏è Part 2 ‚Äî Long Turn';
    else lbl='üí° Part 3 ‚Äî Q'+(idx-state.p1Count-state.p2Count+1)+'/'+state.p3Count;
    document.getElementById('modeIndicator').textContent=lbl;
  }
  setTimeout(function(){speakText(item.q);},400);
}
function updateProgress(c,t){var p=Math.round(c/t*100);document.getElementById('progressLabel').textContent='Question '+(c+1)+' of '+t;document.getElementById('progressPct').textContent=p+'%';document.getElementById('progressFill').style.width=p+'%';}
function setHint(mode){
  state.hintMode = mode;
  document.getElementById('hintNone').classList.toggle('active', mode==='none');
  document.getElementById('hintKw').classList.toggle('active', mode==='keywords');
  document.getElementById('hintNone').textContent = mode==='none' ? 'üôà Hints hidden' : 'üó£Ô∏è Answer without hints';
  document.getElementById('hintKw').textContent   = mode==='keywords' ? 'üëÅÔ∏è Key words shown' : 'üí° Show my key words';
  var kb = document.getElementById('keywordsBox');
  if(mode === 'keywords'){
    kb.classList.add('show');
    renderKwChips();
  } else {
    kb.classList.remove('show');
  }
}

function addKwChip(){
  var input = document.getElementById('kwInput');
  var val = (input.value||'').trim();
  if(!val) return;
  var idx = state.currentIndex;
  if(!state.questions[idx]) return;
  // Runtime keywords added during speaking (separate from setup keywords)
  if(!state.questions[idx].runtimeKw) state.questions[idx].runtimeKw = [];
  var all = (state.questions[idx].userKw||[]).concat(state.questions[idx].runtimeKw);
  if(!all.some(function(k){ return k.toLowerCase()===val.toLowerCase(); })){
    state.questions[idx].runtimeKw.push(val);
  }
  input.value = ''; input.focus();
  renderKwChips();
}

function removeKwChip(word, isRuntime){
  var idx = state.currentIndex;
  if(!state.questions[idx]) return;
  if(isRuntime){
    state.questions[idx].runtimeKw = (state.questions[idx].runtimeKw||[]).filter(function(k){ return k!==word; });
  } else {
    state.questions[idx].userKw = (state.questions[idx].userKw||[]).filter(function(k){ return k!==word; });
  }
  renderKwChips();
}

function renderKwChips(){
  var container = document.getElementById('kwChips');
  if(!container) return;
  var idx = state.currentIndex;
  var q = state.questions[idx];
  // Setup keywords (prepared before speaking) + runtime keywords (added during speaking)
  var setupKws   = (q && q.userKw)    || [];
  var runtimeKws = (q && q.runtimeKw) || [];
  // Merge, no duplicates
  var allKws = setupKws.slice();
  runtimeKws.forEach(function(k){
    if(!allKws.some(function(s){ return s.toLowerCase()===k.toLowerCase(); })) allKws.push(k);
  });

  if(!allKws.length){
    container.innerHTML = '<span style="color:var(--text3);font-size:13px;">No keywords yet ‚Äî type below to add</span>';
    return;
  }
  var colors = ['','teal','blue','orange','green','teal','blue','orange'];
  container.innerHTML = allKws.map(function(k, i){
    var safe = k.replace(/'/g,"\\'");
    var rt   = runtimeKws.indexOf(k) !== -1 && setupKws.indexOf(k) === -1;
    return '<span class="kw-chip '+(colors[i%colors.length]||'')+'" style="cursor:pointer;" '
      +'onclick="removeKwChip(\''+safe+'\','+(rt?'true':'false')+')" title="Click to remove">'
      +k+' <span style="opacity:.55;font-size:11px;">‚úï</span></span>'
      +(i < allKws.length-1 ? '<span class="kw-arrow">‚Üí</span>' : '');
  }).join('');
}

function renderKW(){ renderKwChips(); }

// ========== TIMER ==========
function startTimer(type,seconds){
  stopTimer();
  var disp=document.getElementById('timerDisplay'),val=document.getElementById('timerValue'),bar=document.getElementById('timerBarFill'),lbl=document.getElementById('timerLabel');
  disp.style.display='block';
  if(type==='countdown'){
    lbl.textContent='TIME REMAINING';state.timerSeconds=seconds;bar.style.width='100%';
    var t=function(){val.textContent=fmt(state.timerSeconds);bar.style.width=(Math.max(0,state.timerSeconds)/seconds*100)+'%';if(state.timerSeconds<=0){val.classList.add('blink-red');val.classList.remove('blink-green');}else{val.classList.remove('blink-red');state.timerSeconds--;}};
    t();state.timerInterval=setInterval(t,1000);
  } else {
    lbl.textContent='TIME ELAPSED';state.timerSeconds=0;bar.style.width='0%';
    var t2=function(){val.textContent=fmt(state.timerSeconds);bar.style.width=Math.min(state.timerSeconds/seconds*100,100)+'%';if(state.timerSeconds>=seconds){val.classList.add('blink-green');val.classList.remove('blink-red');}else val.classList.remove('blink-green');state.timerSeconds++;};
    t2();state.timerInterval=setInterval(t2,1000);
  }
}
function stopTimer(){if(state.timerInterval){clearInterval(state.timerInterval);state.timerInterval=null;}var v=document.getElementById('timerValue');if(v)v.classList.remove('blink-red','blink-green');}
function fmt(s){if(s<0)s=0;var m=Math.floor(s/60),sec=s%60;return(m<10?'0':'')+m+':'+(sec<10?'0':'')+sec;}

// ========== MICROPHONE ‚Äî Chrome optimised, no duplicate words ==========
// Root cause of duplicate: Chrome fires onend + restarts ‚Üí resultIndex resets to 0
// Fix: never use continuous=true with auto-restart. Instead use a single-shot
// recognition that we manually restart, and we track a "committed" offset so
// interim results from the new session never overlap with already-committed text.

var _recRestartTimer = null;

function initSpeech(){
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ showToast('Speech recognition requires Chrome.','error'); return null; }

  var rec = new SR();
  rec.continuous      = false;   // single-shot per segment ‚Äî avoids Chrome duplicate bug
  rec.interimResults  = true;
  rec.lang            = 'en-US';
  rec.maxAlternatives = 1;

  rec.onresult = function(e){
    var interim = '';
    for(var i = 0; i < e.results.length; i++){
      if(e.results[i].isFinal){
        // Only append truly new final text (deduplicate trailing space)
        var t = e.results[i][0].transcript.trim();
        if(t) state.transcript += t + ' ';
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    var box = document.getElementById('transcriptBox');
    box.textContent = state.transcript + interim;
    box.style.fontStyle = 'normal';
  };

  rec.onerror = function(e){
    if(e.error === 'not-allowed' || e.error === 'permission-denied'){
      document.getElementById('micNotice').classList.add('show');
      showToast('‚ö†Ô∏è Please allow microphone access','error');
      stopRecording();
    }
    // For 'no-speech' or 'audio-capture' just restart silently
  };

  rec.onend = function(){
    if(state.isRecording){
      // Small delay prevents "already started" Chrome error
      _recRestartTimer = setTimeout(function(){
        if(state.isRecording){
          try{ state.recognition.start(); }catch(x){}
        }
      }, 80);
    }
  };

  return rec;
}

function toggleRecording(){ if(state.isRecording) stopRecording(); else startRecording(); }

function startRecording(){
  document.getElementById('micNotice').classList.remove('show');
  // Always create a fresh recognition instance to avoid Chrome state bugs
  if(state.recognition){ try{ state.recognition.abort(); }catch(x){} }
  state.recognition = initSpeech();
  if(!state.recognition) return;

  stopSpeaking();
  state.isRecording = true;

  try{ state.recognition.start(); }catch(e){}

  document.getElementById('micBtn').classList.add('recording');
  document.getElementById('micBtn').innerHTML = '<svg viewBox="0 0 24 24" style="width:26px;height:26px;fill:#fff;stroke:none;"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';
  document.getElementById('micStatus').textContent = 'üî¥ Recording... tap to stop';
  document.getElementById('waveform').classList.add('active');

  if(!state.timerStarted){
    state.timerStarted = true;
    var idx = state.currentIndex;
    var isP2 = (state.mode==='part2') || (state.mode==='simulation' && idx>=state.p1Count && idx<state.p1Count+state.p2Count);
    var isP3 = (state.mode==='part3') || (state.mode==='simulation' && idx>=state.p1Count+state.p2Count);
    if(isP2) startTimer('countdown',120);
    else if(isP3) startTimer('countup',45);
  }
}

function stopRecording(){
  state.isRecording = false;
  if(_recRestartTimer){ clearTimeout(_recRestartTimer); _recRestartTimer = null; }
  if(state.recognition){ try{ state.recognition.stop(); }catch(e){} }
  document.getElementById('micBtn').classList.remove('recording');
  document.getElementById('micBtn').innerHTML = '<svg viewBox="0 0 24 24" id="micIcon" style="width:32px;height:32px;fill:none;stroke:#fff;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/></svg>';
  document.getElementById('micStatus').innerHTML = 'Tap to start speaking &nbsp;|&nbsp; <kbd style="background:var(--bg2);padding:2px 7px;border-radius:4px;border:1px solid var(--border);font-size:12px;">Space</kbd>';
  document.getElementById('waveform').classList.remove('active');
}

function clearTranscript(){
  state.transcript = '';
  state.timerStarted = false;
  var b = document.getElementById('transcriptBox');
  b.textContent = 'Your speech will appear here...';
  b.style.fontStyle = 'italic';
}

// ========== SUBMIT ==========
function submitAnswer(){
  var answer=state.transcript.trim();if(!answer){showToast('Please record your answer first!','error');return;}
  if(state.isRecording)stopRecording();
  if(state.mode==='cefr')submitCEFR(answer);else submitIELTS(answer);
}

// ‚îÄ‚îÄ Inline thinking indicator (replaces full-screen overlay for feedback) ‚îÄ‚îÄ
var _loadingTimer = null;

function showAnimatedLoading(msgs) {
  // Don't use full-screen overlay ‚Äî show inline under the question instead
  var area = document.getElementById('feedbackArea');
  var i = 0;
  area.innerHTML =
    '<div id="inlineThinking" style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:#fff;border:1.5px solid var(--border);border-radius:12px;margin-top:4px;">' +
      '<div style="display:flex;gap:5px;align-items:center;">' +
        '<div class="think-dot"></div>' +
        '<div class="think-dot"></div>' +
        '<div class="think-dot"></div>' +
      '</div>' +
      '<div id="thinkingMsg" style="font-size:calc(var(--fs)-1px);color:var(--text2);font-weight:500;"></div>' +
    '</div>';
  document.getElementById('thinkingMsg').textContent = msgs[0];
  _loadingTimer = setInterval(function(){
    i = (i + 1) % msgs.length;
    var el = document.getElementById('thinkingMsg');
    if(el) el.textContent = msgs[i];
  }, 1800);
}

function hideAnimatedLoading() {
  if(_loadingTimer){ clearInterval(_loadingTimer); _loadingTimer = null; }
  // feedbackArea will be overwritten by renderFeedback ‚Äî no need to clear
}

function submitIELTS(answer){
  var item = state.questions[state.currentIndex];
  var partMap = {part1:'Part 1',part2:'Part 2',part3:'Part 3',simulation:'IELTS'};
  var usedHint = state.hintMode === 'keywords';
  document.getElementById('submitBtn').disabled = true;

  // Show animated loading steps
  showAnimatedLoading([
    'üéôÔ∏è Processing your answer...',
    '‚úèÔ∏è Checking your grammar...',
    'üìö Analysing vocabulary...',
    'üî¢ Calculating your Band Score...',
    'üí° Preparing suggestions...'
  ]);

  gasCall('getIELTSFeedback',[item.q, answer, partMap[state.mode]||'IELTS'],
    function(raw){
      hideAnimatedLoading();
      try{
        var data = typeof raw==='string' ? JSON.parse(raw) : raw;
        state.results.push({
          question:item.q, studentAnswer:answer,
          corrected:data.corrected, suggestion:data.suggestion,
          scores:data.scores, overall:data.overall,
          summary:data.summary, usedHint:usedHint,
          hintKeywords:usedHint?(item.kw||[]).join(', '):''
        });
        renderFeedback(data, usedHint, answer);
        document.getElementById('nextBtn').style.display = 'block';
      }catch(e){ showToast('Error parsing response. Try again.','error'); }
      document.getElementById('submitBtn').disabled = false;
    },
    function(err){
      hideAnimatedLoading();
      showToast('Connection error: '+err.message,'error');
      document.getElementById('submitBtn').disabled = false;
    }
  );
}

function renderFeedback(data, usedHint, studentAnswer){
  var ov = parseFloat(data.overall)||0;
  var ht = usedHint
    ? '<span class="hint-tag yes">üí° With key words</span>'
    : '<span class="hint-tag no">üó£Ô∏è Without hints</span>';
  var correctedHtml = data.corrected
    ? buildDiffHtml(studentAnswer||'', data.corrected)
    : 'No corrections needed! ‚úÖ';

  // Format summary as bullet points if it contains line breaks or semicolons
  var summaryHtml = (data.summary||'');
  if(summaryHtml.indexOf('‚Ä¢')!==-1||summaryHtml.indexOf('-')===0||summaryHtml.indexOf('\n')!==-1){
    var lines = summaryHtml.split(/\n|‚Ä¢|;/).map(function(s){return s.replace(/^[-‚Ä¢\s]+/,'').trim();}).filter(Boolean);
    summaryHtml = '<ul style="margin:6px 0 0 16px;padding:0;line-height:1.8;">'+lines.map(function(l){return'<li>'+l+'</li>';}).join('')+'</ul>';
  }

  document.getElementById('feedbackArea').innerHTML =
    '<div class="feedback-card">'+
    '<div class="feedback-header">'+
      '<div class="feedback-title">‚ú® Feedback '+ht+'</div>'+
      '<div class="score-badge">Band '+ov.toFixed(1)+'</div>'+
    '</div>'+
    '<div style="margin-bottom:12px;">'+
      '<div style="font-size:11px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;">CORRECTED VERSION</div>'+
      '<div class="diff-box">'+correctedHtml+'</div>'+
    '</div>'+
    '<div class="scores-grid">'+
      rsi('üó£Ô∏è Fluency',data.scores&&data.scores.fluency)+
      rsi('üìö Lexical',data.scores&&data.scores.lexical)+
      rsi('‚úèÔ∏è Grammar',data.scores&&data.scores.grammar)+
      rsi('üîä Pronunciation',data.scores&&data.scores.pronunciation)+
    '</div>'+
    (data.suggestion?
      '<div class="suggestion-box"><div class="suggestion-label">üí° BAND 7.0+ SUGGESTION</div>'+
      '<div style="font-size:var(--fs);line-height:1.7;color:var(--text);">'+data.suggestion+'</div></div>':'')+
    '<div class="summary-text">'+summaryHtml+'</div>'+
    '</div>';

  document.getElementById('feedbackArea').scrollIntoView({behavior:'smooth',block:'start'});
}
function rsi(label,obj){return'<div class="score-item"><div class="score-item-label">'+label+'</div><div class="score-item-val">'+(obj?parseFloat(obj.score).toFixed(1):'-')+'</div><div class="score-item-comment">'+(obj?obj.comment||'':'')+'</div></div>';}

// ========== CEFR QUESTION POOL ==========
// Shuffled fresh every session. Questions mapped to approximate CEFR levels.
var CEFR_POOL = {
  A1: [
    "What's your name, please?",
    "What town do you come from?",
    "How many people are there in your family?",
    "Do you have any brothers and sisters?",
    "Do you have a pet?",
    "What time do you often get up?",
    "What time do you go to bed?",
    "What is your favorite food?",
    "Do you like sports?",
    "What do you often eat for breakfast?",
    "Do you watch TV every day?",
    "What did you eat this morning?",
    "Do you have your own room?",
    "What is your favorite room in the house?",
    "Who is your best friend?"
  ],
  A2: [
    "What's the name of your school?",
    "Do you like going to school?",
    "What is your favorite subject?",
    "How do you travel to school every day?",
    "How long is your summer vacation?",
    "What sort of music do you like?",
    "Do you often listen to music in your free time?",
    "Do you have a computer at home?",
    "How often do you surf the Internet?",
    "Are you interested in shopping?",
    "What do you usually do at weekends?",
    "What do you do in your spare time?",
    "What did you do last weekend? Did you enjoy yourself?",
    "What do you think of your hometown?",
    "Do you like travelling? Why or why not?",
    "Did you go away on holiday last year?",
    "Do you play any sports?",
    "Do you often watch sports on TV?",
    "How often do you eat in a restaurant?",
    "Do you always eat dinner with your family?",
    "Why do you like your best friend?",
    "Do you have a lot of friends?",
    "How often do you hang out with friends?",
    "Do you pay much attention to your health?",
    "Do you do exercise every day?",
    "What time do you get up in the morning?",
    "Where do you come from?",
    "What do you usually do at the weekends?",
    "How often do you watch TV?",
    "What subjects do you study at school?",
    "What is your favourite meal of the day?",
    "What food do you like?",
    "Do you like shopping for clothes?",
    "What is the weather like in your country?",
    "What countries have you visited?"
  ],
  B1: [
    "How much time do you spend doing your homework every day?",
    "How often do you do housework?",
    "What are you going to do next weekend?",
    "Which country would you like to visit? Why?",
    "Do you think playing sports is necessary?",
    "What do you think is the most popular sport in the world?",
    "What food do you think is unhealthy?",
    "What qualities do you think are necessary for a true friend?",
    "What should people do to keep fit?",
    "Do you often stay up late?",
    "Talk about your favorite travelling destination.",
    "How many subjects do you have at school?",
    "Do you have to take extra classes?",
    "What do you often go shopping for?",
    "Do you usually read books? What kind?",
    "Have you travelled to another country?",
    "Are you a member of any sports team?",
    "What do you do to keep fit?",
    "Is there any food that you really dislike? Why?",
    "Why do you think friendship is necessary?",
    "Are you in good health? What do you do for your health?",
    "What type of TV programmes do you prefer watching?",
    "Tell me something about your best friend.",
    "What do you like about your school?",
    "Is your diet healthy? Why or why not?",
    "Tell me about the last time you went shopping.",
    "Which subject do you like best? Why?",
    "What's the most beautiful place in your town?"
  ],
  B2: [
    "What do you think is the most dangerous sport? Why?",
    "How has the Internet changed the way people communicate?",
    "What are the advantages and disadvantages of social media?",
    "Do you think technology helps or hurts students' learning?",
    "How important is it to learn a foreign language today?",
    "What would you change about your education system?",
    "How do you think your hometown has changed over the years?",
    "What do you think makes a healthy lifestyle?",
    "How do you think people's eating habits have changed?",
    "What role does sport play in modern society?",
    "How important is family in your culture?",
    "What do you think is the biggest challenge facing young people today?",
    "If you could live in any country, where would you choose and why?",
    "How has travel changed people's understanding of other cultures?",
    "What do you think are the qualities of a good friend?",
    "How do you balance school and free time?",
    "What are your ambitions for the future?",
    "How has your daily routine changed since you started school?",
    "What advice would you give to someone learning English?",
    "How do you think shopping habits have changed with the Internet?"
  ]
};

// Per-session shuffled pool and used-question tracking
var _cefrSessionPool = [];   // flat array of {q, level} shuffled for this session
var _cefrPoolIndex   = 0;    // next question to ask

function _initCEFRPool() {
  _cefrSessionPool = [];
  // Pick questions per level according to cefrLevels schedule (8 questions)
  // We pre-build a shuffled pool of 30+ questions, then pick in order
  var allLevels = ['A1','A2','B1','B2'];
  allLevels.forEach(function(lv){
    var qs = CEFR_POOL[lv].slice(); // copy
    shuffle(qs);
    qs.forEach(function(q){ _cefrSessionPool.push({q:q, level:lv}); });
  });
  // Final shuffle of entire pool so questions from different levels mix naturally
  shuffle(_cefrSessionPool);
  _cefrPoolIndex = 0;
}

function _nextCEFRQuestion(level) {
  // Get next unused question from pool, preferring the target level
  // First try to find one matching the level
  for(var i = _cefrPoolIndex; i < _cefrSessionPool.length; i++){
    if(_cefrSessionPool[i].level === level){
      var q = _cefrSessionPool[i].q;
      // Remove from pool by swapping with current index
      var tmp = _cefrSessionPool[_cefrPoolIndex];
      _cefrSessionPool[_cefrPoolIndex] = _cefrSessionPool[i];
      _cefrSessionPool[i] = tmp;
      _cefrPoolIndex++;
      return q;
    }
  }
  // Fallback: just take the next available question
  if(_cefrPoolIndex < _cefrSessionPool.length){
    return _cefrSessionPool[_cefrPoolIndex++].q;
  }
  return null;
}

// ========== CEFR ==========
function startCEFR(){
  document.getElementById('chatContainer').innerHTML='';
  _initCEFRPool(); // fresh shuffle every session
  addBubble('examiner',"Hello! Welcome to your CEFR speaking test. I'll ask you some questions. Just speak naturally ‚Äî there are no wrong answers! Ready?",'A1');
  setTimeout(function(){
    var q = _nextCEFRQuestion('A1');
    if(q){
      addBubble('examiner', q, 'A1');
      state.cefrHistory.push({q:q, a:null});
    }
  }, 800);
}

function submitCEFR(answer){
  if(!state.cefrHistory.length) return;
  var last = state.cefrHistory[state.cefrHistory.length-1];
  var question = last.q; last.a = answer;
  addBubble('student', answer);
  document.getElementById('submitBtn').disabled = true;
  addTyping();

  gasCall('getCEFRFeedback',[question, answer, state.cefrLevel],
    function(raw){
      removeTyping();
      try{
        var data = typeof raw==='string' ? JSON.parse(raw) : raw;
        var capped = Math.min(parseFloat(data.overall)||0, 6.5);
        state.results.push({
          question:question, studentAnswer:answer,
          corrected:data.corrected, suggestion:data.suggestion,
          scores:data.scores, overall:capped,
          summary:data.summary, usedHint:false, hintKeywords:''
        });

        // Show brief inline feedback in chat
        var corrNote = data.corrected && data.corrected.trim() !== answer.trim()
          ? '<br><span style="color:var(--teal);font-size:12px;">‚úèÔ∏è <i>' + data.corrected + '</i></span>' : '';
        var fb = '<div style="font-size:12px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">'
          + '<b style="color:var(--blue)">Band: '+capped.toFixed(1)+'</b>'
          + (data.summary ? ' ¬∑ '+data.summary : '')
          + corrNote
          + '</div>';
        addBubble('examiner', 'Thank you!' + fb, state.cefrLevel);

        var asked = state.results.length;
        if(asked < cefrLevels.length) state.cefrLevel = cefrLevels[asked];
        document.getElementById('submitBtn').disabled = false;
        clearTranscript();

        if(asked < 8){
          setTimeout(function(){
            var nextQ = _nextCEFRQuestion(state.cefrLevel);
            if(nextQ){
              addBubble('examiner', nextQ, state.cefrLevel);
              state.cefrHistory.push({q:nextQ, a:null});
            } else {
              addBubble('examiner',"That's all my questions. Well done! Click 'End Session' to see your results.", state.cefrLevel);
            }
          }, 600);
        } else {
          addBubble('examiner',"That concludes your speaking test. Well done! Click 'End Session' to see your results.", state.cefrLevel);
        }
      }catch(e){
        showToast('Error parsing feedback.','error');
        document.getElementById('submitBtn').disabled = false;
      }
    },
    function(err){
      removeTyping();
      showToast('Error: '+err.message,'error');
      document.getElementById('submitBtn').disabled = false;
    }
  );
}
function addBubble(type,text,level){
  var chat=document.getElementById('chatContainer');var b=document.createElement('div');b.className='chat-bubble '+type;
  var lb=(type==='examiner'&&level)?'<span class="cefr-badge">'+level+'</span>':'';var isEx=type==='examiner';
  b.innerHTML='<div class="bubble-label '+(isEx?'examiner-label':'student-label')+'">'+(isEx?'üë®‚Äçüíº Examiner'+lb:'üë§ '+state.studentName)+'</div><div>'+text+'</div>';
  chat.appendChild(b);chat.scrollTop=chat.scrollHeight;
  if(isEx&&text.indexOf('<div')===-1){setTimeout(function(){speakText(text);},300);}
}
function addTyping(){var c=document.getElementById('chatContainer');var d=document.createElement('div');d.id='typingBubble';d.className='chat-bubble examiner';d.innerHTML='<div class="bubble-label examiner-label">üë®‚Äçüíº Examiner</div><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function removeTyping(){var t=document.getElementById('typingBubble');if(t)t.remove();}
function nextQuestion(){stopTimer();var n=state.currentIndex+1;if(n>=state.questions.length){endSession();return;}loadQ(n);}

// ========== END SESSION ==========
function confirmEnd(){ if(confirm('End session and submit your results?')) endSession(); }

function endSession(){
  if(state.sessionEnded) return;
  state.sessionEnded = true;
  stopTimer();
  if(state.isRecording) stopRecording();

  var endTime  = new Date();
  var duration = Math.round((endTime - new Date(state.startingTime)) / 60000);

  var payload = {
    studentName:    state.studentName,
    accessCode:     state.accessCode,
    mode:           state.mode,
    simMode:        state.simMode,
    startingTime:   formatDateTime(new Date(state.startingTime)),
    submittingTime: formatDateTime(endTime),
    duration:       duration,
    results:        state.results
  };

  // Step 1: store full data in GAS PropertiesService (no URL length limit)
  gasCall('storeTempData', [payload],
    function(res){
      if(res && res.success && res.token){
        // Step 2: trigger actual sheet write using just the token
        gasCall('saveToSheet', [{ token: res.token }],
          function(r){ if(!r || !r.success) console.warn('Sheet save issue:', r); },
          function(e){ console.warn('Sheet save failed:', e); }
        );
      } else {
        console.warn('storeTempData failed:', res);
      }
    },
    function(e){ console.warn('storeTempData error:', e); }
  );

  goToPage(3);
  buildReview();
}

// ========== REVIEW ==========
function buildReview(){
  var r=state.results;if(!r.length){document.getElementById('finalScore').textContent='--';return;}
  var ov=r.map(function(x){return parseFloat(x.overall)||0;}).filter(function(s){return s>0;});
  var avg=ov.length?ov.reduce(function(a,b){return a+b;},0)/ov.length:0;
  var capped=state.mode==='cefr'?Math.min(avg,6.5):avg;
  document.getElementById('finalScore').textContent=capped.toFixed(1);
  document.getElementById('finalScoreSub').textContent=state.mode==='cefr'?'CEFR Equivalent Score (max 6.5)':'Average IELTS Band Score';
  var keys=['fluency','lexical','grammar','pronunciation'],icons={fluency:'üó£Ô∏è',lexical:'üìö',grammar:'‚úèÔ∏è',pronunciation:'üîä'};
  var bd={};
  keys.forEach(function(k){var vals=r.map(function(x){return x.scores&&x.scores[k]?parseFloat(x.scores[k].score)||0:0;}).filter(function(v){return v>0;});bd[k]=vals.length?(vals.reduce(function(a,b){return a+b;},0)/vals.length).toFixed(1):'--';});
  document.getElementById('breakdownSummary').innerHTML=keys.map(function(k){return'<div style="text-align:center;"><div style="font-size:26px;font-weight:800;">'+bd[k]+'</div><div style="font-size:12px;opacity:.8;">'+icons[k]+' '+k.charAt(0).toUpperCase()+k.slice(1)+'</div></div>';}).join('');
}
function toggleReview(){
  var list=document.getElementById('reviewList'),btn=document.getElementById('reviewToggleBtn');
  if(list.style.display==='none'){list.style.display='block';btn.textContent='üîº Hide Review';renderReview();}
  else{list.style.display='none';btn.textContent='üìã Review My Answers';}
}
function renderReview(){
  document.getElementById('reviewList').innerHTML=state.results.map(function(r,i){
    var ht=r.usedHint?'<span class="hint-tag yes">üí° With key words</span>':'<span class="hint-tag no">üó£Ô∏è No hints</span>';
    var diffHtml=r.corrected?buildDiffHtml(r.studentAnswer,r.corrected):'';
    return'<div class="review-item"><div class="review-item-num">Question '+(i+1)+'</div><div class="review-question">'+r.question+'</div><div style="margin-bottom:8px;">'+ht+'</div>'+
      '<div style="font-size:11px;color:var(--text3);margin-bottom:5px;font-weight:700;text-transform:uppercase;">Your Answer:</div><div class="review-student">"'+r.studentAnswer+'"</div>'+
      (diffHtml?'<div style="font-size:11px;color:var(--teal);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:1px;">Corrected:</div><div class="review-corrected">'+diffHtml+'</div>':'')+
      '<div class="review-scores">'+rrs('Fluency',r.scores&&r.scores.fluency)+rrs('Lexical',r.scores&&r.scores.lexical)+rrs('Grammar',r.scores&&r.scores.grammar)+rrs('Pronunciation',r.scores&&r.scores.pronunciation)+'</div>'+
      '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><span style="font-size:13px;color:var(--text2);">Overall:</span><span style="font-size:20px;font-weight:800;color:var(--blue);">Band '+parseFloat(r.overall||0).toFixed(1)+'</span></div>'+
      (r.suggestion?'<div class="suggestion-box" style="margin-bottom:10px;"><div class="suggestion-label">üí° Band 7.0+ Suggestion</div><div style="font-size:calc(var(--fs)-1px);line-height:1.7;color:var(--text);">'+r.suggestion+'</div></div>':'')+
      '<div class="review-summary">üìã '+(r.summary||'')+'</div></div>';
  }).join('');
}
function rrs(l,obj){return'<div class="review-score-chip"><div class="rscore-val">'+(obj?parseFloat(obj.score).toFixed(1):'--')+'</div><div class="rscore-lbl">'+l+'</div></div>';}

// ========== UTILS ==========
function goToPage(n){document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});var id=n===15?'page15':'page'+n;document.getElementById(id).classList.add('active');window.scrollTo(0,0);}
function showLoading(t){document.getElementById('loadingText').textContent=t||'Loading...';document.getElementById('loadingOverlay').classList.add('show');}
function hideLoading(){document.getElementById('loadingOverlay').classList.remove('show');}
function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(function(){t.classList.remove('show');},3500);}
function restartApp(){state.mode='';state.simMode='';state.questions=[];state.results=[];state.currentIndex=0;state.transcript='';state.cefrHistory=[];state.sessionEnded=false;setupData={part1:[],part2:[],part3:[],forecast:''};document.querySelectorAll('.mode-btn,.part-btn,.sim-opt').forEach(function(b){b.classList.remove('selected');});document.getElementById('ieltsParts').classList.remove('show');document.getElementById('simModes').classList.remove('show');document.getElementById('studentName').value='';goToPage(1);}
document.addEventListener('keydown',function(e){if(e.code==='Space'&&e.target.tagName!=='INPUT'&&e.target.tagName!=='TEXTAREA'){e.preventDefault();if(document.getElementById('page2').classList.contains('active'))toggleRecording();}});
</script>
</body>
</html>
